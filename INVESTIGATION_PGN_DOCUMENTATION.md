# Investigation PGN Documentation

This document contains the complete PGN with all alternate branches and detailed annotations for each move.

## Overview

The investigation PGN is generated by the `Investigator` class during dual-depth analysis (D16/D2). It contains:

- **Root PV Sequence**: The principal variation from D16 analysis (deep, accurate)
- **Alternate Branches**: Overestimated moves explored as variations (moves D2 ranked higher than D16)
- **Stopped Branches**: Branches that were stopped early (included with annotations explaining why)
- **Rich Annotations**: Each move includes evaluation, themes, tactics, and tag changes

## PGN Structure

The PGN follows this structure:

```
[Event "Investigation"]
[FEN "starting_position"]
[Starting tags: tag1, tag2, ...]

1. RootMove1 [%eval +X.XX] [%theme "theme"] [%tactic "tactic"] {[gained: ...], [lost: ...], [threats: ...]}
    (1. BranchMove1 [%eval +X.XX] [%theme "stopped_branch"] Branch stopped: reason...)
    (1. BranchMove2 [%eval +X.XX] [%theme "overestimated"] D2 overestimates...)
2. RootMove2 [%eval +X.XX] ...
    (2. BranchMove1 ...)
...
```

## Move Annotations Explained

### Evaluation (`[%eval X.XX]`)
- **Format**: `[%eval +0.28]` or `[%eval -0.15]`
- **Meaning**: Position evaluation in pawns from White's perspective
- **Source**: 
  - D16 eval for first move in root PV
  - D2 eval for subsequent moves in PV
  - D16 or D2 eval for branch moves (depending on availability)

### Themes (`[%theme "theme1,theme2"]`)
- **Format**: `[%theme "center_space,king_safety"]`
- **Meaning**: Positional themes identified in the position after the move
- **Source**: Light raw analysis (computed after each move)
- **Common themes**: `center_space`, `king_safety`, `development`, `piece_activity`, `pawn_structure`

### Tactics (`[%tactic "tactic_type"]`)
- **Format**: `[%tactic "fork"]` or `[%tactic "none"]`
- **Meaning**: Tactical pattern detected (humanized tag name)
- **Source**: Tags gained after the move, converted to human-readable form
- **Common tactics**: `fork`, `pin`, `skewer`, `discovered_attack`, `double_attack`

### Commentary (`{[gained: ...], [lost: ...], [threats: ...]}`)
- **Format**: `{[gained: tag1, tag2], [lost: tag3], [threats: threat1, threat2]}`
- **Meaning**: 
  - **gained**: Tags that appeared after this move (up to 10 shown)
  - **lost**: Tags that disappeared after this move (up to 10 shown)
  - **threats**: Tactical threats identified (up to 5 shown)

## Branch Types

### 1. Root PV (Principal Variation)
The main line from D16 analysis - the engine's best continuation at depth 16.

**Characteristics**:
- Highest accuracy (D16 analysis)
- Full PV sequence followed
- Each move annotated with eval, themes, tactics, and tag changes

### 2. Overestimated Branches
Moves that D2 (shallow analysis) ranked higher than D16 (deep analysis) suggests. These are explored to show why they're not actually best.

**Annotation**: `[%theme "overestimated"]`

**Why they exist**: D2 analysis can be fooled by tactical patterns that don't hold up under deeper analysis. These branches show what D2 thought was good but D16 proves is inferior.

### 3. Stopped Branches
Branches that were stopped early due to various conditions:

**Stop Reasons**:
- **`d2_eval_below_original`**: D2 eval dropped below the original position's D16 eval
  - **Annotation**: `[%theme "stopped_branch,d2_worse_than_original"]`
  - **Commentary**: Shows the eval drop and why the branch was stopped
  
- **`no_overestimated_moves`**: D16 and D2 agree on best move (no more branches to explore)
  - **Annotation**: `[%theme "stopped_branch,d2_d16_agree"]`
  - **Commentary**: "D16 and D2 agree on best move."
  
- **`depth_limit`**: Maximum recursion depth reached (default: 5)
  - **Annotation**: `[%theme "stopped_branch,max_depth_reached"]`
  - **Commentary**: "Maximum recursion depth reached."

**Annotation**: `[%theme "stopped_branch"]` with specific reason in commentary

## How to Access the PGN

The PGN is available in the `InvestigationResult` object:

```python
# From investigate_position
investigation_result = await investigator.investigate_position(
    fen, 
    scope="general_position"  # This triggers dual-depth analysis
)
pgn = investigation_result.pgn_exploration

# From executor result
executor_result = await executor.execute(plan, context)
investigation_result = executor_result.results[1]  # Step 1 is investigate_position
pgn = investigation_result.pgn_exploration
```

## Example PGN Output

```
[Event "Investigation"]
[FEN "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"]
[Starting tags: tag.king.shield.intact, tag.center.control.core, ...]

1. e4 [%eval +0.28] [%theme "center_space,development"] [%tactic "center_control"] {[gained: center control core, key e4], [lost: none], [threats: center control]}
    (1. e4 [%eval +0.25] [%theme "stopped_branch,d2_worse_than_original"] Branch stopped: d2_eval_below_original. D2 eval (+0.25) below original (+0.28), diff: -0.03.)
1... e5 [%eval +0.30] [%theme "center_space,king_safety"] [%tactic "none"] {[gained: key e5], [lost: none], [threats: none]}
2. Nf3 [%eval +0.32] [%theme "development,piece_activity"] [%tactic "knight_development"] {[gained: knight development, piece activity], [lost: none], [threats: knight activity]}
    (2. d4 [%eval +0.24] [%theme "overestimated"] D2 overestimates. Threat: center_control.)
2... Nf6 [%eval +0.28] [%theme "development,king_safety"] [%tactic "knight_development"] {[gained: knight development], [lost: none], [threats: none]}
...
```

## Technical Details

### Eval Standardization
All evaluations are standardized to White's perspective:
- **+eval**: White is winning/advantaged
- **-eval**: Black is winning/advantaged

This is done via the `_score_to_white_cp()` method in `Investigator`.

### Tag Humanization
Raw tag names (e.g., `tag.tactic.fork`, `tag.king.attackers.count`) are converted to human-readable form (e.g., "fork", "king attackers") via the `_humanize_tag()` method.

### Branch Exploration Logic
1. **D16 Analysis**: Deep analysis (depth 16) finds the true best move
2. **D2 Analysis**: Shallow analysis (depth 2) finds what looks good quickly
3. **Comparison**: Moves ranked higher by D2 than D16 are "overestimated"
4. **Exploration**: Each overestimated move is explored recursively
5. **Stopping**: Branches stop when:
   - D2 eval drops below original position
   - D16 and D2 agree (no more overestimated moves)
   - Maximum depth reached (5 levels)

### Recursion Limit
Maximum branch depth is **5** to prevent infinite exploration. This is configurable via the `depth_limit` parameter in `_explore_branch_recursive()`.

## Notes

- **Stopped branches are included**: Even stopped branches are added to the PGN with annotations explaining why they stopped
- **Full PV sequences**: The root PV follows the complete principal variation, not just the first move
- **Tag changes tracked**: Each move shows which tags were gained/lost, providing insight into positional changes
- **Threat detection**: Threats are identified and shown in the commentary for each move

---

*This document is automatically generated from the investigation results. The actual PGN content will vary based on the position analyzed.*
